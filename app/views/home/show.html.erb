<% if current_user %>
  <div class="page-header">
    <h1>Here is some info about you...</h1>
  </div>
  <div class="panel panel-default">
    <div class="panel-body">

      <canvas id="canvas"
      width="400"
      height="400"
      data-mouth-left-x="<%= @pic.mouth_left_x %>"
      data-mouth-right-x="<%= @pic.mouth_right_x %>"
      data-nose-y="<%= @pic.nose_y %>"
      ></canvas>

      <script type="text/javascript">
        var canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        var userImage = new Image();

        userImage.onload = function(){
          var width = userImage.clientWidth;
          var height = userImage.clientHeight;
          var scaleWidth = 400 / width;
          var scaleHeight = 400 / height;
          ctx.scale(scaleWidth,scaleHeight);
          ctx.drawImage(userImage,0,0);
          ctx.scale(1/scaleWidth,1/scaleHeight);
          document.body.removeChild(userImage);

          var stacheImage = new Image;
          stacheImage.onload = function(){
            var width = userImage.clientWidth;
            var height = userImage.clientHeight;
            var scaleWidth = 400 / width;
            var scaleHeight = 400 / height;
            ctx.translate(188.318668,197.776) //mouthleft x times 4, nose y times 4
            ctx.scale(scaleWidth,scaleHeight);
            var inScaleWidth = (47.356664 / 400 ) * 1.3//width calculations (mouth left x - mouth right x)
            ctx.scale(inScaleWidth,inScaleWidth)
            ctx.drawImage(stacheImage,-50,-80);
            document.body.removeChild(stacheImage)
            var data = canvas.toDataURL('image/jpeg');
            var blob = dataURItoBlob(dataURL);
            var fd = new FormData(document.forms[0]);
            fd.append("canvasImage", blob);
          }
          stacheImage.src = "http://i.imgur.com/rJ71NVK.png"
          document.body.appendChild(stacheImage);

        }

      // y mouthavg  48.61916675 * 4
      // width 11.839166 * 4

        userImage.src = "http://avatars.slack-edge.com/2016-03-01/23827508289_8e0c5fc47896904c9086_1024.jpg";

        document.body.appendChild(userImage);

        function dataURItoBlob(dataURI) {
    // convert base64/URLEncoded data component to raw binary data held in a string
    var byteString;
    if (dataURI.split(',')[0].indexOf('base64') >= 0)
        byteString = atob(dataURI.split(',')[1]);
    else
        byteString = unescape(dataURI.split(',')[1]);

    // separate out the mime component
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

    // write the bytes of the string to a typed array
    var ia = new Uint8Array(byteString.length);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }

    return new Blob([ia], {type:mimeString});
}
      </script>
      <%= form_for(:pic, url: '/save_that_stache') do |f| %>
        <%= f.submit "Save Stached Me" %>
      <% end %>
      <div class="center-block">
        <%= image_tag current_user.image_url, alt: current_user.name, class: "user_image" %>
      </div>
      <ul>
        <li><strong>Name:</strong> <%= current_user.name %></li>
        <li><strong>Provider:</strong> <%= current_user.provider %></li>
        <li><strong>uID:</strong> <%= current_user.uid %></li>
        <li><strong>Avatar URL:</strong> <%= current_user.image_url %></li>
      </ul>
    </div>
  </div>

<% end %>
